name: CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04]
        build_type: [Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ rpm
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=ON \
          -DBUILD_TOOLS=ON \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j$(nproc)
    
    - name: Run tests
      run: cd build && ctest --output-on-failure
    
    - name: Check library files
      run: |
        ls -lh build/src/libiubpatch.*
        file build/src/libiubpatch.*

  release:
    name: Build Release Packages
    runs-on: ubuntu-22.04
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
        else
          echo "version=0.1.0" >> $GITHUB_OUTPUT
        fi
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          rpm \
          dpkg-dev \
          file
    
    - name: Configure CMake for Release
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=ON \
          -DBUILD_STATIC_LIBS=ON \
          -DBUILD_TOOLS=ON \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_TESTS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr
    
    - name: Build Release
      run: cmake --build build --config Release -j$(nproc)
    
    - name: Create DEB packages
      run: |
        cd build
        cpack -G DEB
        ls -lh *.deb
    
    - name: Create RPM packages
      run: |
        cd build
        cpack -G RPM
        ls -lh *.rpm
    
    - name: Create TGZ archive
      run: |
        cd build
        cpack -G TGZ
        ls -lh *.tar.gz
    
    - name: Calculate checksums
      run: |
        cd build
        sha256sum *.deb *.rpm *.tar.gz > SHA256SUMS.txt
        cat SHA256SUMS.txt
    
    - name: Upload DEB packages
      uses: actions/upload-artifact@v4
      with:
        name: deb-packages
        path: build/*.deb
        retention-days: 90
    
    - name: Upload RPM packages
      uses: actions/upload-artifact@v4
      with:
        name: rpm-packages
        path: build/*.rpm
        retention-days: 90
    
    - name: Upload TGZ archive
      uses: actions/upload-artifact@v4
      with:
        name: tarball
        path: build/*.tar.gz
        retention-days: 90
    
    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: checksums
        path: build/SHA256SUMS.txt
        retention-days: 90
    
    - name: Upload release assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.deb
          build/*.rpm
          build/*.tar.gz
          build/SHA256SUMS.txt
      env:
        GITHUB_TOKEN: ${{ secrets.MITO_TOKEN }}
